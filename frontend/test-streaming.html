<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streaming Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    h1 {
      color: #7c3aed;
      margin-bottom: 20px;
    }

    .input-section {
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 5px;
      font-size: 14px;
      margin-bottom: 10px;
    }

    button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }

    button:hover {
      background: #6d28d9;
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .output {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 5px;
      padding: 20px;
      min-height: 200px;
      white-space: pre-wrap;
      position: relative;
    }

    .cursor {
      display: inline-block;
      width: 8px;
      height: 16px;
      background: #7c3aed;
      margin-left: 4px;
      animation: blink 1s infinite;
      vertical-align: text-bottom;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .status {
      margin-top: 10px;
      font-size: 12px;
      color: #6b7280;
    }

    .error {
      color: #dc2626;
      background: #fef2f2;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #fecaca;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Streaming API Test</h1>

    <div class="input-section">
      <input
        type="password"
        id="apiKey"
        placeholder="Enter your OpenAI API Key"
      />
      <input
        type="text"
        id="prompt"
        placeholder="Enter a test prompt (e.g., 'Tell me a short story about a wizard')"
        value="Tell me a short story about a wizard"
      />
      <button id="testBtn" onclick="testStreaming()">Test Streaming</button>
    </div>

    <div class="output" id="output"></div>
    <div class="status" id="status"></div>
  </div>

  <script>
    let isStreaming = false;

    async function testStreaming() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const prompt = document.getElementById('prompt').value.trim();
      const output = document.getElementById('output');
      const status = document.getElementById('status');
      const btn = document.getElementById('testBtn');

      if (!apiKey) {
        alert('Please enter your API key');
        return;
      }

      if (!prompt) {
        alert('Please enter a prompt');
        return;
      }

      isStreaming = true;
      btn.disabled = true;
      output.innerHTML = '<span class="cursor"></span>';
      status.textContent = 'Streaming...';

      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model: 'gpt-4o',
            messages: [{ role: 'user', content: prompt }],
            temperature: 0.85,
            max_tokens: 500,
            stream: true,
          }),
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let fullContent = '';
        let chunkCount = 0;
        const startTime = Date.now();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6);
              if (data === '[DONE]') continue;

              try {
                const parsed = JSON.parse(data);
                const content = parsed.choices[0]?.delta?.content || '';
                if (content) {
                  fullContent += content;
                  chunkCount++;
                  output.innerHTML = fullContent + '<span class="cursor"></span>';
                  status.textContent = `Streaming... (${chunkCount} chunks, ${fullContent.length} chars)`;
                }
              } catch (e) {
                // Skip malformed JSON
              }
            }
          }
        }

        const elapsed = ((Date.now() - startTime) / 1000).toFixed(2);
        output.innerHTML = fullContent;
        status.textContent = `âœ“ Complete! (${chunkCount} chunks, ${fullContent.length} chars, ${elapsed}s)`;
        status.style.color = '#059669';

      } catch (err) {
        output.innerHTML = `<div class="error">Error: ${err.message}</div>`;
        status.textContent = 'Failed';
        status.style.color = '#dc2626';
        console.error(err);
      } finally {
        isStreaming = false;
        btn.disabled = false;
      }
    }

    // Allow Enter key in prompt field
    document.getElementById('prompt').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        testStreaming();
      }
    });
  </script>
</body>
</html>
